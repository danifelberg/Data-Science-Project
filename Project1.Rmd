---
title: "Project 1 - Household Energy Expenditures - Electricity"
author: "Sean Franco, Mei Fei Hung, Daniel Felberg"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    number_sections: false
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r init, include=F}
# The package "ezids" (EZ Intro to Data Science) includes some helper functions we developed for the course. 
# Some of the frequently used functions are loadPkg(), xkabledply(), xkablesummary(), uzscale(), etc.
# You will need to install it (once) from GitHub.
# library(devtools)
# devtools::install_github("physicsland/ezids")
# Then load the package in your R session.
#setwd() Meng Fei's WD  
setwd("C:/Users/18045/Documents/R/Data_Intro_Class/Project1")# Sean's WD
#setwd("C:/Users/danif/OneDrive/Documents/GWU - Data Science (Spring 2023)/DATS 6101/Project/Project1.R") Daniel's WD
library(readr)
library(ggplot2)
#install.packages("survey","ggmap","maps","mapdata","formattable", "forcats", "RColorBrewer","gridExtra", "usmap")
library(survey)
library(dplyr)
library(ggmap)
library(maps)
library(mapdata)
library(usmap)
library(formattable)
library(forcats)
library(RColorBrewer)
library(ezids)
library(readxl)
library(gridExtra)
library(lattice)
library(corrplot)
library(reshape2)
```


```{r setup, include=FALSE}
# Some of common RMD options (and the defaults) are: 
# include=T, eval=T, echo=T, results='hide'/'asis'/'markup',..., collapse=F, warning=T, message=T, error=T, cache=T, fig.width=6, fig.height=4, fig.dim=c(6,4) #inches, fig.align='left'/'center','right', 
knitr::opts_chunk$set(warning = F, message = F)
# Can globally set option for number display format.
options(scientific=T, digits = 3) 
# options(scipen=9, digits = 3) 
```

```{r}
#LoadData and Example Code for Assigning weights----- 
#this is example code from the EIA weights doc:

RECS2015 <- read.csv("recs2015_public_v4.csv", header=TRUE, sep=",")

```
```{r}

#PLOT General Appliances comparisons----

app_cost <- data.frame(RECS2015$DOLLAREL,RECS2015$DOLELSPH,RECS2015$DOLELCOL,
                       RECS2015$DOLELWTH,RECS2015$DOLELRFG,RECS2015$DOLELFRZ,
                       RECS2015$DOLELCOK,RECS2015$DOLELMICRO,RECS2015$DOLELCW,
                       RECS2015$DOLELCDR,RECS2015$DOLELDWH,RECS2015$DOLELLGT,
                       RECS2015$DOLELTVREL,RECS2015$DOLELAHUHEAT,RECS2015$DOLELAHUCOL,
                       RECS2015$DOLELEVAPCOL,RECS2015$DOLELCFAN,RECS2015$DOLELDHUM,
                       RECS2015$DOLELHUM,RECS2015$DOLELPLPMP,RECS2015$DOLELHTBPMP,
                       RECS2015$DOLELHTBHEAT,RECS2015$DOLELNEC)

series <- data.frame(rep(1, nrow(app_cost)))
Spaceheating<- RECS2015$DOLELSPH
AC<- RECS2015$DOLELCOL
Waterheating<-RECS2015$DOLELWTH
Refrigerator<-RECS2015$DOLELRFG
Freezer<-RECS2015$DOLELFRZ
Cooking<-RECS2015$DOLELCOK
Microwave<-RECS2015$DOLELMICRO
Clothewasher<-RECS2015$DOLELCW
Clothedryer<-RECS2015$DOLELCDR
Dishwasher<-RECS2015$DOLELDWH
Light<-RECS2015$DOLELLGT
TV<-RECS2015$DOLELTVREL
Airhandlerheating<-RECS2015$DOLELAHUHEAT
Airhandlercooling<-RECS2015$DOLELAHUCOL
Fan<-RECS2015$DOLELCFAN


app_cost <- data.frame(
  Spaceheating, 
  AC, 
  Waterheating,
  Light, 
  TV,
  Dishwasher,
  Refrigerator, 
  Freezer, 
  Cooking, 
  Microwave, 
  Clothewasher, 
  Clothedryer,
  Fan)

colnames(app_cost) <- c(
  "Spaceheating", 
  "AC", 
  "Waterheating",
  "Light", 
  "TV",
  "Dishwasher",
  "Refrigerator", 
  "Freezer", 
  "Cooking", 
  "Microwave", 
  "Clothewasher", 
  "Clothedryer",
  "Fan")

app_cost <- outlierKD2(app_cost, (Spaceheating), rm =TRUE)
app_cost <- outlierKD2(app_cost, (AC), rm =TRUE) 
app_cost <- outlierKD2(app_cost, (Waterheating), rm =TRUE)
app_cost <- outlierKD2(app_cost, (Light), rm =TRUE)
app_cost <- outlierKD2(app_cost, (TV), rm =TRUE)  
app_cost <- outlierKD2(app_cost, (Dishwasher), rm =TRUE)
app_cost <- outlierKD2(app_cost, (Refrigerator), rm =TRUE)
app_cost <- outlierKD2(app_cost, (Freezer), rm =TRUE)
app_cost <- outlierKD2(app_cost, (Cooking), rm =TRUE)
app_cost <- outlierKD2(app_cost, (Microwave), rm =TRUE)
app_cost <- outlierKD2(app_cost, (Clothewasher), rm =TRUE)
app_cost <- outlierKD2(app_cost, (Clothedryer), rm =TRUE)
app_cost <- outlierKD2(app_cost, (Fan), rm =TRUE)

app_cost["series"] <- rep(1, nrow(app_cost))

test <- melt(app_cost,  id.vars = 'series', variable.name = 'index')

test %>%
  arrange(index)%>%
  mutate(index = factor(index, levels = c("series",
                                          "Waterheating",
                                          "AC",
                                          "Spaceheating", 
                                          "Light", 
                                          "TV",
                                          "Clothedryer",
                                          "Refrigerator", 
                                          "Fan",
                                          "Freezer", 
                                          "Cooking", 
                                          "Microwave", 
                                          "Dishwasher",
                                          "Clothewasher"))) %>%
  ggplot(
    aes(x = series,
        y = value,
        fill = index))+ 
  geom_bar(stat = "identity", 
           position = "dodge") +
  labs(title = "Annual Electricity Cost of Different Appliances", 
       x = "Appliances",
       y = "Annual Electricity Cost")+  
  theme(axis.text.x = element_blank())
```
See above is a plot of common appliances and their total yearly electricity usage. We can notice that waterheating, spaceheating and air conditioning, are among the top appliances that consume electricity. Examining central air costs for heating and cooling are among the top energy expenses for households. 

```{r}
#Electricity costs for space heating (“DOLELSPH” variable),

RECS2015$DOLELSPH <- currency(RECS2015$DOLELSPH,
                              symbol = "$",
                              digits = 0L,
                              format = "f",
                              big.mark = ",",
                              sep = "")
svytotal(~DOLELSPH, des)

#Electricity costs for air conditioning (“DOLELCOL” variable),

RECS2015$DOLELCOL <- currency(RECS2015$DOLELCOL,
                              symbol = "$",
                              digits = 0L,
                              format = "f",
                              big.mark = ",",
                              sep = "")
svytotal(~DOLELCOL, des)

#Heat Pump

RECS2015 <- RECS2015 %>% 
  mutate(CENACHP = as.factor(case_when(CENACHP == 1 ~ "Has a Heat Pump",
                                       CENACHP == 0 ~ "No Heat Pump",
                                       CENACHP == -2 ~ "NA")))

svytotal(~CENACHP, des)

central_air_df <- data.frame(RECS2015$DOLELSPH, 
                             RECS2015$DOLELCOL, 
                             RECS2015$CENACHP)

colnames(central_air_df) <- c("Electricity Space Heating Costs", 
                              "Electricity AC Costs", 
                              "Heat Pump Status")
RECS2015 %>%
  filter(EQUIPM == 4)%>%
  select(EQUIPM)
  
#PLOT heatpump v. space heating costs----
ggplot(central_air_df, 
       aes(x = `Heat Pump Status`,
           y = `Electricity Space Heating Costs`,
           fill = `Heat Pump Status`))+
  geom_bar(stat = "identity", position = "dodge")+
  labs(title = "Yearly Space Heating Costs (in $) ")
```
This plot shows that for heating costs, households with heat pumps roughly save half of their heating costs that households without heat pumps. A T-test (see below) indicated that the difference between households with heatpumps is significant for total, yearly heating costs.

```{r}
#PLOT heatpump v. ac costs----
ggplot(central_air_df, 
       aes(x = `Heat Pump Status`,
           y = `Electricity AC Costs`,
           fill = `Heat Pump Status`))+
  geom_bar(stat = "identity", position = "dodge")+
  labs(title = "Yearly AC Costs (in $)")
```
This plot shows that for cooling costs, households with heat pumps also save almost $500 a year  in total cooling costs compared to households without heat pumps. A T-test (see below) indicated that the difference between households with heatpumps is significant for total, yearly AC costs.

```{r}
#T-Test for heatpumps v. spaceheater----

ttest_central_air_df <- central_air_df %>%
  mutate(`alt` = central_air_df$`Heat Pump Status` == "Has a Heat Pump",
         'null' = central_air_df$`Heat Pump Status` == "No Heat Pump")

no_hp <- ttest_central_air_df %>%
  filter(null == TRUE)
    
has_hp <- ttest_central_air_df %>%
  filter(alt == TRUE)

t.test(x = has_hp$`Electricity Space Heating Costs`,
       conf.level = 0.95,
       mu = mean(no_hp$`Electricity Space Heating Costs`))

#T-Test for heatpumps v. AC-----

no_hp <- ttest_central_air_df %>%
  filter(null == TRUE)

has_hp <- ttest_central_air_df %>%
  filter(alt == TRUE)

t.test(x = has_hp$`Electricity AC Costs`,
       conf.level = 0.95,
       mu = mean(no_hp$`Electricity AC Costs`))

```

```{r}
#----------------------Income and Energy Expenditure info----------------------- ------
#Annual gross household income for the last year (“MONEYPY” variable),

RECS2015 <- RECS2015 %>%
  mutate(MONEYPY = as.factor(case_when(MONEYPY == 1 ~ "Less than $20,000",
                                       MONEYPY == 2 ~ "$20,000 - $39,999",
                                       MONEYPY == 3 ~ "$40,000 - $59,999",
                                       MONEYPY == 4 ~ "$60,000 to $79,999",
                                       MONEYPY == 5 ~ "$80,000 to $99,999",
                                       MONEYPY == 6 ~ "$100,000 to $119,999",
                                       MONEYPY == 7 ~ "$120,000 to $139,999",
                                       MONEYPY == 8 ~ "$140,000 or more")))

central_air_df["Income"] <- data.frame(RECS2015$MONEYPY)

has_hp <- central_air_df %>%
  filter(`Heat Pump Status` == "Has a Heat Pump")

no_hp <- central_air_df %>%
  filter(`Heat Pump Status` == "No Heat Pump")

central_air_df %>%
  arrange(`Heat Pump Status`) %>%
  mutate(Income = factor(Income, levels = c("Less than $20,000",
                                            "$20,000 - $39,999",
                                            "$40,000 - $59,999",
                                            "$60,000 to $79,999",
                                            "$80,000 to $99,999",
                                            "$100,000 to $119,999",
                                            "$120,000 to $139,999",
                                            "$140,000 or more")))%>%
  ggplot(aes(x = Income,
             y = `Heat Pump Status`,
             fill = `Heat Pump Status`))+
  geom_bar(stat = "identity")+
  labs(title = "Income Bracket And Heat Pump Status",
       ylab = "")+
  theme(axis.text.x = element_text(angle = 45, size = 9, margin = margin(r=0)),
        axis.text.y=element_blank()) #needs to fix income brackets to be ascending

```

See above is a bar plot of Heat pump status as binary counts based on household income brakets. Based on ocular scrutiny, higher income brackets report larger ratios of having heatpumps. The $20k - $39k income bracket have the highest counts of not having heatpumps, and having heat pumps. The $40k - $59k; $140k to more income brackets have high ratios of having heat pumps.

#put anova test here

```{r}

#BOXPLOT of income and yearly energy costs----
central_air_df["TotElectricity"] <- RECS2015$DOLLAREL

central_air_df <- outlierKD2(central_air_df, TotElectricity, rm= TRUE)

#PLOT income by total electricity usage-----
central_air_df %>%
  arrange(`Heat Pump Status`) %>%
  mutate(Income = factor(Income, levels = c("Less than $20,000",
                                            "$20,000 - $39,999",
                                            "$40,000 - $59,999",
                                            "$60,000 to $79,999",
                                            "$80,000 to $99,999",
                                            "$100,000 to $119,999",
                                            "$120,000 to $139,999",
                                            "$140,000 or more")))%>%
  ggplot(aes(x = Income,
             y = TotElectricity, 
             color = Income)) + 
  geom_boxplot(stat = "boxplot") +
  labs(title = "Yearly Electricity Cost by Income Level ", 
       x = "Income level",
       y = "Yearly Electricity Cost (in $)")+  
  theme(axis.text.x = element_text(angle = 45, size = 9, margin = margin(r=0)), 
        axis.text.y=element_text())
```

See above are boxplots of income brackets and total yearly electricity costs. On averge, lower incomes tend to spend less on electricity costs, compared to higher incomes. This is also supported in literature about energy poverty and cultural practices to save energy. 

#put Anova test here

```{r}
Tot_Energy_area_df %>%
  arrange(`Yearly Electricity Costs`)%>%
  mutate(Division = factor(Division, levels = c("New England",
                                                "Middle Atlantic",
                                                "East North Central",
                                                "West North Central",
                                                "South Atlantic",
                                                "East South Central",
                                                "West South Central",
                                                "Mountain North",
                                                "Mountain South",
                                                "Pacific")))%>%
  ggplot(
    aes(x = `Urban Density`,
        y = `Yearly Electricity Costs`,
        fill = fct_reorder(`Division`, `Yearly Electricity Costs`)))+
  geom_boxplot(stat = "boxplot", 
               position = "dodge")+
  labs(title = "Urban Density and Electricity Costs",
       fill= "Division")+
  theme(axis.text.x = element_text(size = 9, margin = margin(r=0)), 
        axis.text.y=element_text())+ 
  scale_color_brewer(palette = "Pastel2")

chisq.test(Tot_Energy_area_df[c(1,2)])
```

See above is a boxplot of census divisions and total yearly electricity costs. We can observe that households in rural areas spend more on electricity than Urban or Urban Clusters. We can also observe that urban areas genereally have high populations which may explain the more distant outliers. 